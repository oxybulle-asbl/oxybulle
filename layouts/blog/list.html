{{ define "main" }}
  {{ partial "page-header" . }}

  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10 xl:col-8">
          
          <!-- Filtres par catégorie -->
          {{ partial "metro-filters.html" . }}
          
          <div class="metro-timeline">
            <!-- Liste complète des stations métro (SANS pagination) -->
            <div class="metro-line">
              {{ range $index, $page := .RegularPages }}
                {{ $colorIndex := mod $index 4 }}
                {{ $lineClass := "" }}
                {{ if eq $colorIndex 0 }}
                  {{ $lineClass = "metro-line-primary" }}
                {{ else if eq $colorIndex 1 }}
                  {{ $lineClass = "metro-line-green" }}
                {{ else if eq $colorIndex 2 }}
                  {{ $lineClass = "metro-line-yellow" }}
                {{ else }}
                  {{ $lineClass = "metro-line-orange" }}
                {{ end }}
                
                {{ $category := "other" }}
                {{ if $page.Params.categories }}
                  {{ $category = index $page.Params.categories 0 | lower }}
                {{ end }}
                
                <div class="metro-station {{ $lineClass }}" data-line="{{ add $colorIndex 1 }}" data-category="{{ $category }}">
                  
                  <!-- Station circle avec date -->
                  <div class="metro-station-circle">
                    <div class="metro-date">
                      <span class="metro-day">{{ $page.Date.Format "02" }}</span>
                      <span class="metro-month">
                        {{ $page.Date.Format "Jan" | replaceRE "Jan" "JAN" | replaceRE "Feb" "FEV" | replaceRE "Mar" "MAR" | replaceRE "Apr" "AVR" | replaceRE "May" "MAI" | replaceRE "Jun" "JUN" | replaceRE "Jul" "JUL" | replaceRE "Aug" "AOU" | replaceRE "Sep" "SEP" | replaceRE "Oct" "OCT" | replaceRE "Nov" "NOV" | replaceRE "Dec" "DEC" }}
                      </span>
                      <span class="metro-year">{{ $page.Date.Format "06" }}</span>
                    </div>
                  </div>
                  
                  <!-- Contenu de la station -->
                  <div class="metro-station-content">
                    <div class="metro-station-info">
                      <!-- Titre avec emoji et icônes -->
                      <span class="metro-station-name">
                        <!-- Emoji selon la catégorie (non cliquable) -->
                        {{ if $page.Params.categories }}
                          <span class="metro-emoji">{{ partial "metro-filters.html" $category }}</span>
                        {{ end }}
                        
                        <!-- Lien optimisé -->
                        {{ partial "metro-link.html" $page }}
                        
                      </span>
                      
                      <!-- Description -->
                      {{ if $page.Content }}
                        {{ $content := $page.Content | plainify | truncate 200 "..." }}
                        {{ if $content }}
                          <span class="metro-description">
                            {{ $content }}
                          </span>
                        {{ end }}
                      {{ end }}
                    </div>
                  </div>
                </div>
              {{ end }}
            </div>
          </div>
          
          <!-- Compteur d'éléments visibles -->
          <div class="metro-counter">
            <span id="visible-count">{{ len .RegularPages }}</span> / {{ len .RegularPages }} éléments
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- JavaScript amélioré pour les filtres et la copie -->
  <script>

// Script métro timeline - Version propre et optimisée
document.addEventListener('DOMContentLoaded', function() {
  
  // === ÉLÉMENTS DOM ===
  const filterButtons = document.querySelectorAll('.filter-btn');
  const allStations = document.querySelectorAll('.metro-station');
  const counterElement = document.getElementById('visible-count');
  
  // === ÉTAT INITIAL ===
  let currentFilter = 'all';
  let isAnimating = false;
  
  // === FONCTIONS UTILITAIRES ===
  
  /**
   * Obtient toutes les stations correspondant au filtre
   */
  function getStationsForFilter(filter) {
    if (filter === 'all') {
      return Array.from(allStations);
    }
    return Array.from(allStations).filter(station => 
      station.getAttribute('data-category') === filter
    );
  }
  
  /**
   * Met à jour le compteur d'éléments
   */
  function updateCounter(count) {
    const total = allStations.length;
    counterElement.textContent = count;
  }
  
  /**
   * Gère la classe last-visible pour arrêter la ligne métro
   */
  function updateMetroLine(visibleStations) {
    // Retirer la classe de toutes les stations
    allStations.forEach(station => station.classList.remove('last-visible'));
    
    // Ajouter la classe à la dernière station visible
    if (visibleStations.length > 0) {
      const lastStation = visibleStations[visibleStations.length - 1];
      lastStation.classList.add('last-visible');
    }
  }
  
  /**
   * Réinitialise toutes les stations (les rend visibles)
   */
  function resetAllStations() {
    allStations.forEach(station => {
      station.style.display = 'flex';
      station.style.opacity = '1';
      station.style.transform = 'translateX(0)';
    });
  }
  
  /**
   * Masque les stations non filtrées
   */
  function hideStations(stationsToHide) {
    stationsToHide.forEach(station => {
      station.style.opacity = '0';
      station.style.transform = 'translateX(-20px)';
      setTimeout(() => {
        station.style.display = 'none';
      }, 200);
    });
  }
  
  /**
   * Affiche les stations filtrées avec animation en cascade
   */
  function showStations(stationsToShow) {
    stationsToShow.forEach((station, index) => {
      setTimeout(() => {
        station.style.display = 'flex';
        station.style.opacity = '0';
        station.style.transform = 'translateX(-20px)';
        
        // Animation d'entrée
        setTimeout(() => {
          station.style.opacity = '1';
          station.style.transform = 'translateX(0)';
        }, 50);
      }, index * 30); // Délai de 30ms entre chaque station
    });
  }
  
  /**
   * Applique le filtre sélectionné
   */
  function applyFilter(selectedFilter) {
    if (isAnimating) return;
    
    isAnimating = true;
    currentFilter = selectedFilter;
    
    // Obtenir les stations à afficher selon le filtre
    const stationsToShow = getStationsForFilter(selectedFilter);
    const stationsToHide = Array.from(allStations).filter(
      station => !stationsToShow.includes(station)
    );
    
    // Mettre à jour immédiatement le compteur
    updateCounter(stationsToShow.length);
    
    if (selectedFilter === 'all') {
      // Cas spécial "Tout" : réinitialiser toutes les stations
      resetAllStations();
      updateMetroLine(stationsToShow);
      setTimeout(() => {
        isAnimating = false;
      }, 300);
    } else {
      // Masquer les stations non filtrées
      hideStations(stationsToHide);
      
      // Attendre que le masquage soit terminé, puis afficher les bonnes stations
      setTimeout(() => {
        showStations(stationsToShow);
        updateMetroLine(stationsToShow);
        
        // Animation terminée
        setTimeout(() => {
          isAnimating = false;
        }, stationsToShow.length * 30 + 200);
      }, 250);
    }
  }
  
  /**
   * Met à jour l'état actif des boutons de filtre
   */
  function updateActiveButton(activeButton) {
    filterButtons.forEach(btn => btn.classList.remove('active'));
    activeButton.classList.add('active');
  }
  
  // === ÉVÉNEMENTS ===
  
  /**
   * Gestion des clics sur les boutons de filtre
   */
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      if (isAnimating) return; // Empêcher les clics multiples
      
      const filter = this.getAttribute('data-filter');
      
      // Ne rien faire si c'est déjà le filtre actuel
      if (filter === currentFilter) return;
      
      updateActiveButton(this);
      applyFilter(filter);
    });
  });
  
  // === INITIALISATION ===
  
  /**
   * Initialise l'état par défaut
   */
  function initialize() {
    // S'assurer que toutes les stations sont visibles au départ
    resetAllStations();
    
    // Mettre à jour le compteur initial
    updateCounter(allStations.length);
    
    // Gérer la ligne métro initiale
    updateMetroLine(Array.from(allStations));
    
    // S'assurer que le bouton "Tout" est actif
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
      updateActiveButton(allButton);
    }
  }
  
  // Lancer l'initialisation
  initialize();
  
});


  </script>
{{ end }}