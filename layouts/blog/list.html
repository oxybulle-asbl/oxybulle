{{ define "main" }}
  {{ partial "page-header" . }}

  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10 xl:col-8">
          
          <!-- Filtres par catÃ©gorie -->
          <div class="metro-filters mb-8">
            <div class="filter-buttons">
              <button class="filter-btn active" data-filter="all">
                <span class="filter-emoji">ðŸŒŸ</span>
                Tout
              </button>
              <button class="filter-btn" data-filter="infolettre">
                <span class="filter-emoji">ðŸ“œ</span>
                Infolettres
              </button>
              <button class="filter-btn" data-filter="evenement">
                <span class="filter-emoji">ðŸŽ­</span>
                Ã‰vÃ¨nements
              </button>
              <button class="filter-btn" data-filter="action">
                <span class="filter-emoji">ðŸ“¢</span>  
                Actions
              </button>
              <button class="filter-btn" data-filter="presse">
                <span class="filter-emoji">ðŸ“°</span>
                Presse
              </button>
            </div>
          </div>
          
          <div class="metro-timeline">
            <!-- Liste complÃ¨te des stations mÃ©tro (SANS pagination) -->
            <div class="metro-line">
              {{ range $index, $page := .RegularPages }}
                {{ $colorIndex := mod $index 4 }}
                {{ $lineClass := "" }}
                {{ if eq $colorIndex 0 }}
                  {{ $lineClass = "metro-line-primary" }}
                {{ else if eq $colorIndex 1 }}
                  {{ $lineClass = "metro-line-green" }}
                {{ else if eq $colorIndex 2 }}
                  {{ $lineClass = "metro-line-yellow" }}
                {{ else }}
                  {{ $lineClass = "metro-line-orange" }}
                {{ end }}
                
                {{ $category := "other" }}
                {{ if $page.Params.categories }}
                  {{ $category = index $page.Params.categories 0 | lower }}
                {{ end }}
                
                <div class="metro-station {{ $lineClass }}" data-line="{{ add $colorIndex 1 }}" data-category="{{ $category }}">
                  
                  <!-- Station circle avec date -->
                  <div class="metro-station-circle">
                    <div class="metro-date">
                      <span class="metro-day">{{ $page.Date.Format "02" }}</span>
                      <span class="metro-month">
                        {{ $page.Date.Format "Jan" | replaceRE "Jan" "JAN" | replaceRE "Feb" "FEV" | replaceRE "Mar" "MAR" | replaceRE "Apr" "AVR" | replaceRE "May" "MAI" | replaceRE "Jun" "JUN" | replaceRE "Jul" "JUL" | replaceRE "Aug" "AOU" | replaceRE "Sep" "SEP" | replaceRE "Oct" "OCT" | replaceRE "Nov" "NOV" | replaceRE "Dec" "DEC" }}
                      </span>
                      <span class="metro-year">{{ $page.Date.Format "06" }}</span>
                    </div>
                  </div>
                  
                  <!-- Contenu de la station -->
                  <div class="metro-station-content">
                    <div class="metro-station-info">
                      <!-- Titre avec emoji et icÃ´nes -->
                      <span class="metro-station-name">
                        <!-- Emoji selon la catÃ©gorie (non cliquable) -->
                        {{ if $page.Params.categories }}
                          {{ if eq $category "action" }}
                            <span class="metro-emoji">ðŸ“Œ</span>
                          {{ else if eq $category "evenement" }}
                            <span class="metro-emoji">ðŸŽ­</span>
                          {{ else if eq $category "infolettre" }}
                            <span class="metro-emoji">ðŸ“œ</span>
                          {{ else if eq $category "presse"}}
                            <span class="metro-emoji">ðŸ“°</span>
                          {{ else }}
                            <span class="metro-emoji">ðŸ“„</span>
                          {{ end }}
                        {{ end }}
                        
                        <!-- Titre cliquable avec gestion des liens internes et externes -->
                        {{ $linkUrl := "" }}
                        {{ $hasCustomLink := false }}
                        {{ $isExternal := false }}
                        
                        {{ if $page.Params.external_link }}
                          {{ $linkUrl = $page.Params.external_link }}
                          {{ $hasCustomLink = true }}
                          {{ $isExternal = true }}
                        {{ else if $page.Params.internal_link }}
                          {{ $linkUrl = $page.Params.internal_link | relURL }}
                          {{ $hasCustomLink = true }}
                        {{ end }}
                        
                        {{ if $hasCustomLink }}
                          <a 
                            href="{{ $linkUrl }}" 
                            class="metro-link"
                            {{ if $isExternal }}target="_blank" rel="noopener"{{ end }}
                            title="{{ $page.Title }}"
                          >
                            {{ $page.Title }}
                            <span class="metro-external-icon"><i class="fa fa-external-link"></i></span>
                          </a>
                        {{ else }}
                          <a 
                            href="{{ $page.Permalink }}" 
                            class="metro-link"
                            title="{{ $page.Title }}"
                          >
                            {{ $page.Title }}
                          </a>
                        {{ end }}
                        
                      </span>
                      
                      <!-- Description -->
                      {{ if $page.Content }}
                        {{ $content := $page.Content | plainify | truncate 200 "..." }}
                        {{ if $content }}
                          <span class="metro-description">
                            {{ $content }}
                          </span>
                        {{ end }}
                      {{ end }}
                    </div>
                  </div>
                </div>
              {{ end }}
            </div>
          </div>
          
          <!-- Compteur d'Ã©lÃ©ments visibles -->
          <div class="metro-counter">
            <span id="visible-count">{{ len .RegularPages }}</span> / {{ len .RegularPages }} Ã©lÃ©ments
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- JavaScript amÃ©liorÃ© pour les filtres et la copie -->
  <script>
    // Filtres par catÃ©gorie
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const stations = document.querySelectorAll('.metro-station');
      const visibleCountElement = document.getElementById('visible-count');
      
      function updateCounter() {
        const visibleStations = Array.from(stations).filter(station => 
          station.style.display !== 'none' && station.offsetParent !== null
        );
        visibleCountElement.textContent = visibleStations.length;
      }
      
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Mise Ã  jour des boutons actifs
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          const filter = this.getAttribute('data-filter');
          
          // Filtrage des stations avec animation
          let delay = 0;
          stations.forEach((station, index) => {
            const category = station.getAttribute('data-category');
            
            if (filter === 'all' || category === filter) {
              // Afficher avec dÃ©lai pour effet cascade
              setTimeout(() => {
                station.style.display = 'flex';
                station.style.opacity = '0';
                station.style.transform = 'translateX(-20px)';
                
                // Animation d'entrÃ©e
                setTimeout(() => {
                  station.style.opacity = '1';
                  station.style.transform = 'translateX(0)';
                }, 50);
              }, delay);
              delay += 30; // DÃ©calage de 30ms entre chaque Ã©lÃ©ment
            } else {
              // Masquer immÃ©diatement
              station.style.opacity = '0';
              station.style.transform = 'translateX(-20px)';
              setTimeout(() => {
                station.style.display = 'none';
              }, 300);
            }
          });
          
          // Mettre Ã  jour le compteur aprÃ¨s l'animation
          setTimeout(updateCounter, 400);
        });
      });
      
      // Boutons de copie
      const copyButtons = document.querySelectorAll('.metro-copy-icon');
      
      copyButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const url = this.getAttribute('data-url');
          
          // Copier dans le presse-papier
          navigator.clipboard.writeText(url).then(() => {
            showCopyFeedback(this, true);
          }).catch(() => {
            // Fallback pour navigateurs plus anciens
            try {
              const tempInput = document.createElement('input');
              tempInput.value = url;
              document.body.appendChild(tempInput);
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);
              showCopyFeedback(this, true);
            } catch (err) {
              showCopyFeedback(this, false);
            }
          });
        });
      });
      
      function showCopyFeedback(button, success) {
        const originalText = button.textContent;
        const originalTitle = button.title;
        
        if (success) {
          button.textContent = 'âœ“';
          button.title = 'CopiÃ© !';
          button.style.color = '#10b981'; // Vert
        } else {
          button.textContent = 'âœ—';
          button.title = 'Erreur de copie';
          button.style.color = '#ef4444'; // Rouge
        }
        
        setTimeout(() => {
          button.textContent = originalText;
          button.title = originalTitle;
          button.style.color = '';
        }, 1500);
      }
      
      // Initialiser le compteur
      updateCounter();
    });
  </script>
{{ end }}