{{ define "main" }}
  {{ partial "page-header" . }}

  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10 xl:col-8">
          
          <!-- Filtres par catÃ©gorie -->
          <div class="metro-filters mb-8">
            <div class="filter-buttons">
              <button class="filter-btn active" data-filter="all">
                <span class="filter-emoji">ðŸŒŸ</span>
                Tout
              </button>
              <button class="filter-btn" data-filter="infolettre">
                <span class="filter-emoji">ðŸ“œ</span>
                Infolettres
              </button>
              <button class="filter-btn" data-filter="evenement">
                <span class="filter-emoji">ðŸŽ­</span>
                Ã‰vÃ¨nements
              </button>
              <button class="filter-btn" data-filter="action">
                <span class="filter-emoji">ðŸ“¢</span>  
                Actions
              </button>
              <button class="filter-btn" data-filter="rapport">
                <span class="filter-emoji">ðŸ“Š</span>  
                Rapports
              </button>
              <button class="filter-btn" data-filter="presse">
                <span class="filter-emoji">ðŸ“°</span>
                Presse
              </button>
            </div>
          </div>
          
          <div class="metro-timeline">
            <!-- Liste complÃ¨te des stations mÃ©tro (SANS pagination) -->
            <div class="metro-line">
              {{ range $index, $page := .RegularPages }}
                {{ $colorIndex := mod $index 4 }}
                {{ $lineClass := "" }}
                {{ if eq $colorIndex 0 }}
                  {{ $lineClass = "metro-line-primary" }}
                {{ else if eq $colorIndex 1 }}
                  {{ $lineClass = "metro-line-green" }}
                {{ else if eq $colorIndex 2 }}
                  {{ $lineClass = "metro-line-yellow" }}
                {{ else }}
                  {{ $lineClass = "metro-line-orange" }}
                {{ end }}
                
                {{ $category := "other" }}
                {{ if $page.Params.categories }}
                  {{ $category = index $page.Params.categories 0 | lower }}
                {{ end }}
                
                <div class="metro-station {{ $lineClass }}" data-line="{{ add $colorIndex 1 }}" data-category="{{ $category }}">
                  
                  <!-- Station circle avec date -->
                  <div class="metro-station-circle">
                    <div class="metro-date">
                      <span class="metro-day">{{ $page.Date.Format "02" }}</span>
                      <span class="metro-month">
                        {{ $page.Date.Format "Jan" | replaceRE "Jan" "JAN" | replaceRE "Feb" "FEV" | replaceRE "Mar" "MAR" | replaceRE "Apr" "AVR" | replaceRE "May" "MAI" | replaceRE "Jun" "JUN" | replaceRE "Jul" "JUL" | replaceRE "Aug" "AOU" | replaceRE "Sep" "SEP" | replaceRE "Oct" "OCT" | replaceRE "Nov" "NOV" | replaceRE "Dec" "DEC" }}
                      </span>
                      <span class="metro-year">{{ $page.Date.Format "06" }}</span>
                    </div>
                  </div>
                  
                  <!-- Contenu de la station -->
                  <div class="metro-station-content">
                    <div class="metro-station-info">
                      <!-- Titre avec emoji et icÃ´nes -->
                      <span class="metro-station-name">
                        <!-- Emoji selon la catÃ©gorie (non cliquable) -->
                        {{ if $page.Params.categories }}
                          {{ if eq $category "action" }}
                            <span class="metro-emoji">ðŸ“¢</span>
                          {{ else if eq $category "evenement" }}
                            <span class="metro-emoji">ðŸŽ­</span>
                          {{ else if eq $category "infolettre" }}
                            <span class="metro-emoji">ðŸ“œ</span>
                          {{ else if eq $category "rapport"}}
                            <span class="metro-emoji">ðŸ“Š</span>
                          {{ else if eq $category "presse"}}
                            <span class="metro-emoji">ðŸ“°</span>
                          {{ else }}
                            <span class="metro-emoji">ðŸ“„</span>
                          {{ end }}
                        {{ end }}
                        
                        <!-- Titre cliquable avec gestion des liens internes et externes -->
                        {{ $linkUrl := "" }}
                        {{ $hasCustomLink := false }}
                        {{ $isExternal := false }}
                        
                        {{ if $page.Params.external_link }}
                          {{ $linkUrl = $page.Params.external_link }}
                          {{ $hasCustomLink = true }}
                          {{ $isExternal = true }}
                        {{ else if $page.Params.internal_link }}
                          {{ $linkUrl = $page.Params.internal_link | relURL }}
                          {{ $hasCustomLink = true }}
                        {{ end }}
                        
                        {{ if $hasCustomLink }}
                          <a 
                            href="{{ $linkUrl }}" 
                            class="metro-link"
                            {{ if $isExternal }}target="_blank" rel="noopener"{{ end }}
                            title="{{ $page.Title }}"
                          >
                            {{ $page.Title }}
                            <span class="metro-external-icon"><i class="fa fa-external-link"></i></span>
                          </a>
                        {{ else }}
                          <a 
                            href="{{ $page.Permalink }}" 
                            class="metro-link"
                            title="{{ $page.Title }}"
                          >
                            {{ $page.Title }}
                          </a>
                        {{ end }}
                        
                      </span>
                      
                      <!-- Description -->
                      {{ if $page.Content }}
                        {{ $content := $page.Content | plainify | truncate 200 "..." }}
                        {{ if $content }}
                          <span class="metro-description">
                            {{ $content }}
                          </span>
                        {{ end }}
                      {{ end }}
                    </div>
                  </div>
                </div>
              {{ end }}
            </div>
          </div>
          
          <!-- Compteur d'Ã©lÃ©ments visibles -->
          <div class="metro-counter">
            <span id="visible-count">{{ len .RegularPages }}</span> / {{ len .RegularPages }} Ã©lÃ©ments
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- JavaScript amÃ©liorÃ© pour les filtres et la copie -->
  <script>

// Script mÃ©tro timeline - Version propre et optimisÃ©e
document.addEventListener('DOMContentLoaded', function() {
  
  // === Ã‰LÃ‰MENTS DOM ===
  const filterButtons = document.querySelectorAll('.filter-btn');
  const allStations = document.querySelectorAll('.metro-station');
  const counterElement = document.getElementById('visible-count');
  
  // === Ã‰TAT INITIAL ===
  let currentFilter = 'all';
  let isAnimating = false;
  
  // === FONCTIONS UTILITAIRES ===
  
  /**
   * Obtient toutes les stations correspondant au filtre
   */
  function getStationsForFilter(filter) {
    if (filter === 'all') {
      return Array.from(allStations);
    }
    return Array.from(allStations).filter(station => 
      station.getAttribute('data-category') === filter
    );
  }
  
  /**
   * Met Ã  jour le compteur d'Ã©lÃ©ments
   */
  function updateCounter(count) {
    const total = allStations.length;
    counterElement.textContent = count;
  }
  
  /**
   * GÃ¨re la classe last-visible pour arrÃªter la ligne mÃ©tro
   */
  function updateMetroLine(visibleStations) {
    // Retirer la classe de toutes les stations
    allStations.forEach(station => station.classList.remove('last-visible'));
    
    // Ajouter la classe Ã  la derniÃ¨re station visible
    if (visibleStations.length > 0) {
      const lastStation = visibleStations[visibleStations.length - 1];
      lastStation.classList.add('last-visible');
    }
  }
  
  /**
   * RÃ©initialise toutes les stations (les rend visibles)
   */
  function resetAllStations() {
    allStations.forEach(station => {
      station.style.display = 'flex';
      station.style.opacity = '1';
      station.style.transform = 'translateX(0)';
    });
  }
  
  /**
   * Masque les stations non filtrÃ©es
   */
  function hideStations(stationsToHide) {
    stationsToHide.forEach(station => {
      station.style.opacity = '0';
      station.style.transform = 'translateX(-20px)';
      setTimeout(() => {
        station.style.display = 'none';
      }, 200);
    });
  }
  
  /**
   * Affiche les stations filtrÃ©es avec animation en cascade
   */
  function showStations(stationsToShow) {
    stationsToShow.forEach((station, index) => {
      setTimeout(() => {
        station.style.display = 'flex';
        station.style.opacity = '0';
        station.style.transform = 'translateX(-20px)';
        
        // Animation d'entrÃ©e
        setTimeout(() => {
          station.style.opacity = '1';
          station.style.transform = 'translateX(0)';
        }, 50);
      }, index * 30); // DÃ©lai de 30ms entre chaque station
    });
  }
  
  /**
   * Applique le filtre sÃ©lectionnÃ©
   */
  function applyFilter(selectedFilter) {
    if (isAnimating) return;
    
    isAnimating = true;
    currentFilter = selectedFilter;
    
    // Obtenir les stations Ã  afficher selon le filtre
    const stationsToShow = getStationsForFilter(selectedFilter);
    const stationsToHide = Array.from(allStations).filter(
      station => !stationsToShow.includes(station)
    );
    
    // Mettre Ã  jour immÃ©diatement le compteur
    updateCounter(stationsToShow.length);
    
    if (selectedFilter === 'all') {
      // Cas spÃ©cial "Tout" : rÃ©initialiser toutes les stations
      resetAllStations();
      updateMetroLine(stationsToShow);
      setTimeout(() => {
        isAnimating = false;
      }, 300);
    } else {
      // Masquer les stations non filtrÃ©es
      hideStations(stationsToHide);
      
      // Attendre que le masquage soit terminÃ©, puis afficher les bonnes stations
      setTimeout(() => {
        showStations(stationsToShow);
        updateMetroLine(stationsToShow);
        
        // Animation terminÃ©e
        setTimeout(() => {
          isAnimating = false;
        }, stationsToShow.length * 30 + 200);
      }, 250);
    }
  }
  
  /**
   * Met Ã  jour l'Ã©tat actif des boutons de filtre
   */
  function updateActiveButton(activeButton) {
    filterButtons.forEach(btn => btn.classList.remove('active'));
    activeButton.classList.add('active');
  }
  
  // === Ã‰VÃ‰NEMENTS ===
  
  /**
   * Gestion des clics sur les boutons de filtre
   */
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      if (isAnimating) return; // EmpÃªcher les clics multiples
      
      const filter = this.getAttribute('data-filter');
      
      // Ne rien faire si c'est dÃ©jÃ  le filtre actuel
      if (filter === currentFilter) return;
      
      updateActiveButton(this);
      applyFilter(filter);
    });
  });
  
  // === INITIALISATION ===
  
  /**
   * Initialise l'Ã©tat par dÃ©faut
   */
  function initialize() {
    // S'assurer que toutes les stations sont visibles au dÃ©part
    resetAllStations();
    
    // Mettre Ã  jour le compteur initial
    updateCounter(allStations.length);
    
    // GÃ©rer la ligne mÃ©tro initiale
    updateMetroLine(Array.from(allStations));
    
    // S'assurer que le bouton "Tout" est actif
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
      updateActiveButton(allButton);
    }
  }
  
  // Lancer l'initialisation
  initialize();
  
});


  </script>
{{ end }}